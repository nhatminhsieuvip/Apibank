<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Sử Giao Dịch Ngân Hàng</title>
    <style>
        /* CSS để tạo giao diện giống như ảnh chụp màn hình */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f7f7f7; /* Nền sáng */
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
        }

        /* Vùng điều khiển (Tìm kiếm & Tải lại) */
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #searchInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        #reloadButton {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        #reloadButton:hover {
            background-color: #0056b3;
        }

        /* Thiết kế bảng */
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .transaction-table th, .transaction-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #eee; /* Đường kẻ mỏng */
            vertical-align: top;
        }
        .transaction-table th {
            background-color: #fff; /* Tiêu đề nền trắng */
            color: #777;
            font-weight: bold;
            text-transform: uppercase;
            border-bottom: 2px solid #ddd;
            position: sticky; /* Giữ tiêu đề khi cuộn (tùy chọn) */
            top: 0;
            z-index: 10;
        }
        
        /* Căn chỉnh cột theo ảnh chụp màn hình */
        .transaction-table th:nth-child(1), .transaction-table td:nth-child(1) { width: 15%; } /* Thời gian */
        .transaction-table th:nth-child(2), .transaction-table td:nth-child(2) { width: 15%; } /* Mã GD */
        .transaction-table th:nth-child(3), .transaction-table td:nth-child(3) { width: 10%; text-align: right; } /* Nhận */
        .transaction-table th:nth-child(4), .transaction-table td:nth-child(4) { width: 10%; text-align: right; } /* Chuyển */
        .transaction-table th:nth-child(5), .transaction-table td:nth-child(5) { width: 10%; text-align: right; } /* Số dư */
        .transaction-table th:nth-child(6), .transaction-table td:nth-child(6) { width: auto; } /* Nội dung */

        /* Hiệu ứng di chuột (tùy chọn) */
        .transaction-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* Định dạng tiền tệ theo màu sắc trong ảnh */
        .credit { /* Tiền nhận */
            color: #008000; /* Màu xanh lá cây */
            font-weight: bold;
        }
        .debit { /* Tiền chuyển */
            color: #dc3545; /* Màu đỏ (hoặc hồng như ảnh chụp) */
            font-weight: bold;
        }
        .balance {
            font-weight: bold;
        }
        
        /* Trạng thái tải và lỗi */
        .loading, .error {
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
        }
        .error {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>LỊCH SỬ GIAO DỊCH</h1>
        
        <div class="controls">
            <input type="text" id="searchInput" placeholder="Tìm kiếm theo Mã GD, Nội dung hoặc Ngày...">
            <button id="reloadButton">Tải Lại</button>
        </div>

        <div id="transaction-history">
            <div class="loading">Đang tải dữ liệu...</div>
        </div>
    </div>

    <script>
        // Thay thế bằng link API của bạn
        const API_URL = "https://thueapibank.vn/historyapimbbank/ab3abee7ec1fe9aef4467d2970299c13";
        const historyContainer = document.getElementById('transaction-history');
        const searchInput = document.getElementById('searchInput');
        const reloadButton = document.getElementById('reloadButton');
        
        let allTransactions = []; // Biến lưu trữ toàn bộ dữ liệu giao dịch

        // --- HÀM HỖ TRỢ ---

        // Hàm định dạng số thành tiền tệ Việt Nam (VND)
        const formatCurrency = (amount) => {
            if (amount === null || amount === undefined || amount === "" || parseFloat(amount) === 0) {
                return "0 ₫";
            }
            // Đảm bảo là số để định dạng
            const numericAmount = parseFloat(String(amount).replace(/[^0-9.]/g, ''));
            
            if (isNaN(numericAmount)) {
                return "0 ₫";
            }
            
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND',
                minimumFractionDigits: 0 // Bỏ số thập phân nếu không cần
            }).format(numericAmount);
        };

        // Hàm định dạng ngày/giờ (kết hợp)
        const formatDateTime = (dateString) => {
            if (!dateString) return '';
            try {
                // Tách Ngày và Giờ
                const datePart = dateString.split(' ')[0]; // Lấy phần 'YYYY-MM-DD'
                const timePart = dateString.split(' ')[1]; // Lấy phần 'HH:MM:SS'
                
                // Chuyển đổi định dạng Ngày
                const [year, month, day] = datePart.split('-');
                const formattedDate = `${day}/${month}/${year}`;

                return `
                    ${formattedDate}<br>
                    ${timePart}
                `;
            } catch (e) {
                return dateString;
            }
        };

        // --- HÀM XỬ LÝ DỮ LIỆU VÀ GIAO DIỆN ---

        // Hàm vẽ bảng lịch sử giao dịch
        const renderTransactionTable = (transactions) => {
            if (!transactions || transactions.length === 0) {
                historyContainer.innerHTML = '<div class="loading">Không tìm thấy giao dịch nào phù hợp.</div>';
                return;
            }

            const tableHTML = `
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th>THỜI GIAN</th>
                            <th>MÃ GIAO DỊCH</th>
                            <th style="text-align: right;">SỐ TIỀN NHẬN</th>
                            <th style="text-align: right;">SỐ TIỀN CHUYỂN</th>
                            <th style="text-align: right;">SỐ DƯ</th>
                            <th>NỘI DUNG</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(item => `
                            <tr>
                                <td>${formatDateTime(item.transactionDate)}</td>
                                <td>${item.tranId || ''}</td>
                                <td class="credit">${formatCurrency(item.creditAmount)}</td>
                                <td class="debit">${formatCurrency(item.debitAmount)}</td>
                                <td class="balance">${formatCurrency(item.availableBalance)}</td>
                                <td>${item.description || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            historyContainer.innerHTML = tableHTML;
        };
        
        // Hàm lọc giao dịch theo từ khóa
        const filterTransactions = () => {
            const query = searchInput.value.toLowerCase().trim();
            
            if (query.length === 0) {
                renderTransactionTable(allTransactions); // Hiển thị lại toàn bộ nếu không có từ khóa
                return;
            }

            const filtered = allTransactions.filter(item => {
                // Tạo chuỗi tìm kiếm từ các trường liên quan
                const searchString = [
                    item.tranId,
                    item.transactionDate,
                    item.description,
                    item.creditAmount,
                    item.debitAmount
                ].join(' ').toLowerCase();

                // Lọc nếu chuỗi tìm kiếm chứa từ khóa
                return searchString.includes(query);
            });

            renderTransactionTable(filtered);
        };

        // Hàm gọi API và xử lý dữ liệu gốc
        const fetchTransactionHistory = async () => {
            historyContainer.innerHTML = '<div class="loading">Đang tải dữ liệu...</div>';
            searchInput.value = ''; // Xóa tìm kiếm khi tải lại

            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
                }
                
                const data = await response.json();
                
                let transactions;
                // Giả sử dữ liệu giao dịch nằm trong trường 'data'
                if (data && data.data && Array.isArray(data.data)) {
                    transactions = data.data;
                } else if (data && Array.isArray(data)) {
                    // Nếu API trả về mảng trực tiếp
                    transactions = data;
                } else {
                    throw new Error("Dữ liệu API không hợp lệ.");
                }

                // Lưu dữ liệu gốc và hiển thị
                allTransactions = transactions;
                renderTransactionTable(allTransactions);

            } catch (error) {
                console.error("Lỗi khi tải lịch sử giao dịch:", error);
                historyContainer.innerHTML = `<div class="error">Lỗi khi tải dữ liệu: ${error.message}. Vui lòng kiểm tra lại liên kết API hoặc cấu trúc JSON.</div>`;
            }
        };

        // --- BINDING CÁC SỰ KIỆN ---
        
        // Bắt sự kiện khi người dùng gõ vào ô tìm kiếm
        searchInput.addEventListener('input', filterTransactions);

        // Bắt sự kiện khi người dùng bấm nút Tải Lại
        reloadButton.addEventListener('click', fetchTransactionHistory);

        // Gọi hàm tải dữ liệu khi trang được tải lần đầu
        fetchTransactionHistory();
    </script>

</body>
</html>
